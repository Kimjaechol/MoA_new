name: Release

# Trigger on version tags (e.g., v0.1.0, v1.2.3-beta.1).
on:
    push:
        tags: ["v*"]

permissions:
    contents: write
    id-token: write # Required for cosign keyless signing via OIDC

env:
    CARGO_TERM_COLOR: always

jobs:
    # ── Job 1: Build ZeroClaw server binaries ─────────────────
    build-server:
        name: Server — ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        timeout-minutes: 40
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact: zeroclaw
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: zeroclaw
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: zeroclaw
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: zeroclaw.exe

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Rust dependency cache
              uses: Swatinem/rust-cache@v2

            - name: Install Linux build dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pkg-config libssl-dev

            - name: Build release binary
              run: cargo build --release --locked --target ${{ matrix.target }}

            - name: Check binary size (Unix)
              if: runner.os != 'Windows'
              run: |
                  SIZE=$(stat -f%z target/${{ matrix.target }}/release/${{ matrix.artifact }} 2>/dev/null || stat -c%s target/${{ matrix.target }}/release/${{ matrix.artifact }})
                  echo "Binary size: $((SIZE / 1024 / 1024))MB ($SIZE bytes)"
                  if [ "$SIZE" -gt 10485760 ]; then
                    echo "::warning::Server binary exceeds 10MB"
                  fi

            - name: Package (Unix)
              if: runner.os != 'Windows'
              run: |
                  cd target/${{ matrix.target }}/release
                  tar czf ../../../zeroclaw-${{ matrix.target }}.tar.gz ${{ matrix.artifact }}

            - name: Package (Windows)
              if: runner.os == 'Windows'
              run: |
                  cd target/${{ matrix.target }}/release
                  7z a ../../../zeroclaw-${{ matrix.target }}.zip ${{ matrix.artifact }}

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: server-${{ matrix.target }}
                  path: zeroclaw-${{ matrix.target }}.*
                  if-no-files-found: error

    # ── Job 2: Build Tauri desktop apps ───────────────────────
    build-tauri:
        name: Tauri — ${{ matrix.label }}
        runs-on: ${{ matrix.os }}
        timeout-minutes: 60
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      label: linux-x64
                      target: x86_64-unknown-linux-gnu
                    - os: macos-latest
                      label: macos-x64
                      target: x86_64-apple-darwin
                    - os: macos-latest
                      label: macos-arm64
                      target: aarch64-apple-darwin
                    - os: windows-latest
                      label: windows-x64
                      target: x86_64-pc-windows-msvc

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Rust dependency cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: clients/tauri/src-tauri

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            # Linux-specific system dependencies required by Tauri.
            - name: Install Linux system dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      libwebkit2gtk-4.1-dev \
                      libappindicator3-dev \
                      librsvg2-dev \
                      patchelf \
                      libssl-dev \
                      pkg-config

            - name: Install frontend dependencies
              working-directory: clients/tauri
              run: npm ci

            - name: Build Tauri app
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  projectPath: clients/tauri
                  tauriScript: npx tauri
                  args: --target ${{ matrix.target }}

            # Collect Tauri build artifacts (bundles vary by platform).
            - name: Collect artifacts (Linux)
              if: runner.os == 'Linux'
              run: |
                  mkdir -p tauri-artifacts
                  cp clients/tauri/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb tauri-artifacts/ 2>/dev/null || true
                  cp clients/tauri/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage tauri-artifacts/ 2>/dev/null || true
                  ls -la tauri-artifacts/

            - name: Collect artifacts (macOS)
              if: runner.os == 'macOS'
              run: |
                  mkdir -p tauri-artifacts
                  cp clients/tauri/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg tauri-artifacts/ 2>/dev/null || true
                  ls -la tauri-artifacts/

            - name: Collect artifacts (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  New-Item -ItemType Directory -Force -Path tauri-artifacts
                  Copy-Item "clients\tauri\src-tauri\target\${{ matrix.target }}\release\bundle\msi\*.msi" tauri-artifacts\ -ErrorAction SilentlyContinue
                  Copy-Item "clients\tauri\src-tauri\target\${{ matrix.target }}\release\bundle\nsis\*.exe" tauri-artifacts\ -ErrorAction SilentlyContinue
                  Get-ChildItem tauri-artifacts\

            - name: Upload Tauri artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: tauri-${{ matrix.label }}
                  path: tauri-artifacts/*
                  if-no-files-found: warn

    # ── Job 3: Publish GitHub Release ─────────────────────────
    publish:
        name: Publish Release
        needs: [build-server, build-tauri]
        # Run even if Tauri builds fail (server binaries are the primary deliverable).
        if: always() && needs.build-server.result == 'success'
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Flatten artifact directories
              run: |
                  mkdir -p release
                  find artifacts -type f \( \
                      -name '*.tar.gz' -o \
                      -name '*.zip' -o \
                      -name '*.deb' -o \
                      -name '*.AppImage' -o \
                      -name '*.dmg' -o \
                      -name '*.msi' -o \
                      -name '*.exe' \
                  \) -exec cp {} release/ \;
                  echo "Release artifacts:"
                  ls -lh release/

            - name: Generate SHA256 checksums
              run: |
                  cd release
                  sha256sum * > SHA256SUMS
                  echo "Generated checksums:"
                  cat SHA256SUMS

            - name: Install cosign
              uses: sigstore/cosign-installer@v3

            - name: Sign artifacts with cosign (keyless)
              run: |
                  for file in release/*; do
                    [ -f "$file" ] || continue
                    # Skip signing the checksums file and any existing signatures.
                    case "$file" in
                      *.sig|*.pem|*SHA256SUMS) continue ;;
                    esac
                    cosign sign-blob --yes \
                      --oidc-issuer=https://token.actions.githubusercontent.com \
                      --output-signature="${file}.sig" \
                      --output-certificate="${file}.pem" \
                      "$file"
                  done

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: release/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ── Job 4: Upload to Cloudflare R2 ────────────────────────
    upload-r2:
        name: Upload to Cloudflare R2
        needs: [publish]
        if: always() && needs.publish.result == 'success'
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release directory
              run: |
                  mkdir -p release
                  find artifacts -type f \( \
                      -name '*.tar.gz' -o \
                      -name '*.zip' -o \
                      -name '*.deb' -o \
                      -name '*.AppImage' -o \
                      -name '*.dmg' -o \
                      -name '*.msi' -o \
                      -name '*.exe' \
                  \) -exec cp {} release/ \;

                  # Generate checksums for R2 copy.
                  cd release
                  sha256sum * > SHA256SUMS

            - name: Install AWS CLI
              run: |
                  # AWS CLI is pre-installed on ubuntu-latest runners.
                  aws --version

            - name: Upload to R2
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
                  R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
                  R2_BUCKET: ${{ secrets.R2_BUCKET }}
                  RELEASE_DIR: ./release
                  VERSION: ${{ github.ref_name }}
              run: |
                  # Skip R2 upload if secrets are not configured.
                  if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$R2_ENDPOINT" ] || [ -z "$R2_BUCKET" ]; then
                    echo "R2 secrets not configured. Skipping R2 upload."
                    echo "To enable, add R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_ENDPOINT, and R2_BUCKET to repository secrets."
                    exit 0
                  fi

                  chmod +x ./deploy/r2/upload.sh
                  ./deploy/r2/upload.sh
